!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self)["vue-data-anchor"]=t()}(this,(function(){"use strict";class e{constructor(e,t){this.options={},this.unWatchs={},this.vm=e,this.pluginOptions=t||{},this.register(this.vm.$options.anchor)}register(e=[]){this.getRegisteredOptions(e).forEach((e=>{this.unregister(e.key),this.options[e.key]=e,this.restore(e.key),this.update(e.key),this.unWatchs[e.key]=[this.vm.$watch(e.key,(()=>this.update(e.key))),this.vm.$watch(`$route.query.${e.name}`,(()=>this.restore(e.key)))]}))}unregister(e){return!!this.unWatchs[e]&&(this.unWatchs[e].forEach((e=>e())),delete this.unWatchs[e],delete this.options[e],!0)}update(e){const t=this.options[e];if(!t)throw`[vue-data-anchor]: The '${e}' is not registered, please register first.`;const s=this.getValue(e),i=this.pack(s),r=this.vm.$route.query[t.name];if(i===r)return;const n=t.updateCheck.call(this.vm,e,s);if(null!==n)if(n){if(i!==this.pack("function"==typeof t.defaults?t.defaults.call(this.vm,e):t.defaults)){const e=Object.assign(Object.assign({},this.vm.$route.query),{[t.name]:i});this.vm.$router.replace({query:e})}else if(r){const e=Object.assign({},this.vm.$route.query);delete e[t.name],this.vm.$router.replace({query:e})}}else if(r){const e=Object.assign({},this.vm.$route.query);delete e[t.name],this.vm.$router.replace({query:e})}}restore(e){const t=this.options[e],s=this.vm.$route.query[t.name];if(s){const i=this.unpack(s);t.restore&&t.restore.call(this.vm,e,i)}}pack(e){if(null===e)return"u";const t=typeof e;switch(t){case"string":return"s"+encodeURI(e);case"number":return"0"+encodeURI(e);case"bigint":return"i"+encodeURI(e);case"boolean":return e?"t":"f";case"undefined":return"-";default:throw`[vue-data-anchor]: The value of type "${t}" are not supported.`}}unpack(e){if(void 0===e)return;if("string"!=typeof e){if(!e[0])throw"[vue-data-anchor]: Could not restore value correctly.";e=e[0]}const t=e[0],s=decodeURI(e.slice(1));switch(t){case"s":return s;case"0":return Number(s);case"i":return BigInt(s);case"t":return!0;case"f":return!1;case"-":return;case"u":return null;default:throw"[vue-data-anchor]: Could not restore value correctly. The url may have changed."}}getRegisteredOptions(e){const t=[];for(const s of e){const e="string"==typeof s?s:s.key,i=this.getValue(e);if(null!==i&&"object"==typeof i){const s=Object.keys(i).map((t=>`${e}.${t}`));this.unWatchs[e]=[this.vm.$watch(e,(()=>{s.forEach((e=>this.unregister(e))),this.register([e])})),()=>s.forEach((e=>this.unregister(e)))],t.push(...this.getRegisteredOptions(s))}else if("string"==typeof s)t.push({key:e,name:this.pluginOptions.rename?this.pluginOptions.rename.call(this.vm,e):e.slice(e.lastIndexOf(".")+1),defaults:this.getValue(e),updateCheck:(this.pluginOptions.updateCheck||(()=>!0)).bind(this.vm),restore:(this.pluginOptions.restore||this.setValue).bind(this.vm)});else{const i=s.name?"string"==typeof s.name?s.name:s.name.call(this.vm,e):this.pluginOptions.rename?this.pluginOptions.rename.call(this.vm,e):e.slice(e.lastIndexOf(".")+1);t.push({key:e,name:i,defaults:s.defaults||this.getValue(e),updateCheck:(s.updateCheck||this.pluginOptions.updateCheck||(()=>!0)).bind(this.vm),restore:(s.restore||this.pluginOptions.restore||this.setValue).bind(this.vm)})}}return t}getValue(e){let t=this.vm.$data;return e.split(".").forEach((e=>{t=t[e]})),t}setValue(e,t){let s,i=this.$data,r=e;e.split(".").forEach((e=>{s=i,i=i[e],r=e})),this.$set(s,r,t)}}return{install(t,s){t.mixin({created(){this.$anchor=new e(this,s)}})}}}));
